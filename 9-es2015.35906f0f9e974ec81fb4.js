(window.webpackJsonp=window.webpackJsonp||[]).push([[9],{L99X:function(e,t,n){"use strict";n.d(t,"a",(function(){return h}));var i=n("mrSG"),s=n("c7TG"),o=n("LTmD"),r=n("2Vo4"),l=n("Y6BA"),a=(n("xPBH"),n("fXoL")),c=n("e8h1"),d=n("tk/3");let h=(()=>{class e{constructor(e,t,n,i){this.settings=e,this.plateform=t,this.storage=n,this.http=i,this.dbReady=new r.a(!1),this.LoadBooks().then(e=>{if(this.nodes=e||[],0===this.Nodes.length)return this.CreateNode(void 0,"\u4e34\u65f6\u6848\u4f8b",32)}).finally(()=>{this.dbReady.next(!0)})}ReloadBooks(){this.dbReady.next(!1),this.LoadBooks().then(e=>{this.nodes=e||[]}).finally(()=>{this.dbReady.next(!0)})}get DatabaseState(){return this.dbReady.asObservable()}get Nodes(){return this.nodes.filter(e=>e.size>=0)}get NodesAlle(){return this.nodes}get NodeModified(){return Math.max(...this.nodes.map(e=>e.modified))}GetAllNodes(){return new Promise((e,t)=>{this.DatabaseState.subscribe(t=>{t&&e(this.Nodes)})})}SaveNodes(){const t=this.settings.HasUser?`${e.DB_NODES}_${this.settings.User.id}`:e.DB_NODES;return new Promise((e,n)=>{const i=JSON.stringify(this.nodes);this.storage.set(t,i).then(t=>{e(!0)}).catch(e=>{n(!1)})})}CreateNode(e,t,n){return new Promise((i,s)=>{const o={id:Object(l.createGuid)(8),created:0,modified:0,parent:e,name:t||"\u4e34\u65f6\u6848\u4f8b",comment:"",type:n||1,size:0,sync:0};this.nodes=this.nodes||[],this.nodes.push(o),this.SaveNodes().then(e=>{i(this.Nodes)}).catch(e=>{s(e)})})}ChangeNode(e,t,n=null){return new Promise((i,s)=>{const o=this.nodes.where(t=>t.id===e);if(o&&1===o.length){const e=o[0];e.name=t||e.name,e.parent=n||e.parent,this.SaveNodes().then(e=>{i(this.Nodes)}).catch(e=>{s(!1)})}})}DeleteNodes(e){const t=Date.now();return new Promise((n,i)=>{const s=[];this.nodes.forEach(n=>{e.includes(n.id)&&(n.size=-1,n.modified=t,32===n.type&&s.push(n.id))}),this.SaveNodes().then(e=>{n(this.Nodes)}).catch(e=>{i(!1)})})}SyncNodes(e){const t=this.nodes.map(e=>e.id),n=[],i=[];return e.forEach(e=>{if(t.includes(e.id)){if(this.nodes.find(t=>t.id===e.id).modified<e.modified){const t=this.nodes.findIndex(t=>t.id===e.id);this.nodes.splice(t,1,Object(o.b)(e)),n.push(e.id)}}else this.nodes.push(Object(o.b)(e)),n.push(e.id)}),this.CleanNodes(),this.nodes.forEach(t=>{const n=e.find(e=>e.id===t.id);t.name.startsWith("\u516d\u723b")&&console.log("...",n,t),(!n||n.modified<t.modified)&&i.push(t.id)}),n.length>0?(console.log("new Booktree will be saved.",this.nodes),this.SaveNodes().then(()=>[n,i])):Promise.resolve([n,i])}CleanNodes(){const e=Date.now()-2592e6;this.nodes=this.nodes.filter(t=>t.size<0&&t.modified<e||t.size>=0)}GetRecordes(e){return new Promise((t,n)=>{this.storage.get(`Book_${e}`).then(i=>{if(i){const e=JSON.parse(i);t(e.filter(e=>e.size>=0))}else 0===this.Nodes.find(t=>t.id===e).sync?(this.SaveRecordes(e,[]),t([])):n([])}).catch(e=>{n(e)})})}SaveRecordes(e,t,n=!0){console.log("save recordes of ",e);const i=JSON.stringify(t);if(this.storage.set(`Book_${e}`,i),n){const t=this.nodes.find(t=>t.id===e);t.created=0===t.created?Date.now():t.created,t.modified=Date.now(),t.size=i.length,this.SaveNodes()}}CreateRecord(e,t,n,i){return{id:Object(l.createGuid)(8),node:e,created:Date.now(),modified:Date.now(),type:n,titel:t,arg:i,content:"",size:0,sync:0}}SaveRecord(e,t,n,i){return new Promise((s,o)=>{this.storage.get(`Book_${e}`).then(o=>{const r=JSON.parse(o),l=this.CreateRecord(e,t,n,i);r.push(l),this.SaveRecordes(e,r),s(l)})})}DeleteRecordes(e,t){return new Promise((n,i)=>{this.storage.get(`Book_${e}`).then(i=>{const s=JSON.parse(i);s.forEach(e=>{t.includes(e.id)&&(e.size=-1,e.content="",e.arg="",e.modified=Date.now())}),this.SaveRecordes(e,s),n(s.filter(e=>e.size>=0))})})}MoveRecordes(e,t,n){return new Promise((i,s)=>{const o=this.storage.get(`Book_${e}`).then(e=>JSON.parse(e)||[]),r=this.storage.get(`Book_${t}`).then(e=>JSON.parse(e)||[]);Promise.all([o,r]).then(s=>{let o=s[0];const r=s[1];for(const e of n){const n=o.find(t=>t.id===e);n.node=t,r.push(n),o=o.filter(t=>t.id!==e)}console.log("move finish",o,r,n),this.SaveRecordes(e,o),this.SaveRecordes(t,r),i(o.filter(e=>e.size>=0))})})}ChangeBooktreeOfAnonym(t){const n=`${e.DB_NODES}_${t}`;return this.storage.keys().then(t=>t.includes(n)?Promise.reject(`${n} is already hier.`):this.storage.get(e.DB_NODES)).then(e=>e?(console.log("umschreiben booktree to ",n),this.storage.set(`${n}`,e)):Promise.reject("booktree can not founde.")).then(()=>(console.log("umschreiben erfolg!"),this.storage.remove(e.DB_NODES))).then(()=>(console.log(`Record ${e.DB_NODES} will deleted`),!0)).catch(e=>(console.log("ChangeBooktreeOfAnonym denied: ",e),!1))}test(e){return this.storage.get("...").then(t=>(console.log("get ...",t),this.storage.get(e))).then(t=>(console.log(`get ${e}`,t),Promise.resolve(!0)))}WaitInit(){return new Promise((e,t)=>{this.DatabaseState.subscribe(t=>{t&&e(!0)})})}LoadBooks(){return Object(i.b)(this,void 0,void 0,(function*(){yield this.settings.WaitInit();const t=this.settings.HasUser?`${e.DB_NODES}_${this.settings.User.id}`:e.DB_NODES;return console.log(`loadbooks of ${t}`),this.storage.get(t).then(e=>Promise.resolve(Object(o.d)(e))).catch(e=>(console.error("LoadBooks() error:",e),Promise.resolve([])))}))}}return e.DB_NODES="booktree",e.\u0275fac=function(t){return new(t||e)(a.dc(o.a),a.dc(s.Y),a.dc(c.b),a.dc(d.b))},e.\u0275prov=a.Sb({token:e,factory:e.\u0275fac,providedIn:"root"}),e})()},hBK9:function(e,t,n){"use strict";n.r(t);var i=n("ofXK"),s=n("3Pt+"),o=n("tyNb"),r=n("c7TG"),l=n("mrSG"),a=n("fXoL");const c=function(){var e={arrayBuffer:0,binaryString:1,dataURL:2,text:3};return e[e.arrayBuffer]="arrayBuffer",e[e.binaryString]="binaryString",e[e.dataURL]="dataURL",e[e.text]="text",e}();class d{constructor(e,t,n){this._underlyingFile=e,this._readMode=t,this._content=n}get name(){return this._underlyingFile.name}get size(){return this._underlyingFile.size}get type(){return this._underlyingFile.type}get readMode(){return this._readMode}get content(){return this._content}get underlyingFile(){return this._underlyingFile}}let h=(()=>{class e{constructor(){this.filter=()=>!0,this.readStart=new a.s,this.readEnd=new a.s}readFiles(e,t){return Object(l.b)(this,void 0,void 0,(function*(){const n=Array.from(e).filter(this.filter),i=n.length;this.readStart.emit(i),yield Promise.all(n.map(e=>Object(l.b)(this,void 0,void 0,(function*(){const n=yield function(e,t){return Object(l.b)(this,void 0,void 0,(function*(){return new Promise((n,i)=>{const s=new FileReader;switch(s.onload=i=>{const s=new d(e,t,i.target.result);n(s)},s.onerror=e=>{i(e)},t){case c.arrayBuffer:s.readAsArrayBuffer(e);break;case c.binaryString:s.readAsBinaryString(e);break;case c.text:s.readAsText(e);break;case c.dataURL:default:s.readAsDataURL(e)}})}))}(e,this.readMode);t(n)})))),this.readEnd.emit(i)}))}}return e.\u0275fac=function(t){return new(t||e)},e.\u0275dir=a.Rb({type:e,inputs:{filter:"filter",readMode:"readMode"},outputs:{readStart:"readStart",readEnd:"readEnd"}}),e})(),u=(()=>{class e extends h{constructor(e,t){super(),this.el=e,this.renderer=t,this.accept="",this.filePick=new a.s}get multiple(){return this._multiple}set multiple(e){this._multiple=function(e){return null!=e&&"false"!==`${e}`}(e)}ngOnInit(){this._input=this.renderer.createElement("input"),this.renderer.appendChild(this.el.nativeElement,this._input),this.renderer.setAttribute(this._input,"type","file"),this.renderer.setAttribute(this._input,"accept",this.accept),this.renderer.setStyle(this._input,"display","none"),this.multiple&&this.renderer.setAttribute(this._input,"multiple","multiple"),this.renderer.listen(this._input,"change",e=>this._onListen(e))}reset(){this._input?this._input.value=null:console.error("It seems that ngOnInit() has not been executed or that the hidden _input element is null. Did you mess with the DOM?")}browse(){this._input?this._input.click():console.error("It seems that ngOnInit() has not been executed or that the hidden _input element is null. Did you mess with the DOM?")}_onListen(e){this.readFiles(e.target.files,e=>this.filePick.emit(e))}}return e.\u0275fac=function(t){return new(t||e)(a.Wb(a.q),a.Wb(a.M))},e.\u0275dir=a.Rb({type:e,selectors:[["","ngxFilePicker",""]],hostBindings:function(e,t){1&e&&a.hc("click",(function(e){return t.browse()}))},inputs:{accept:"accept",multiple:"multiple"},outputs:{filePick:"filePick"},exportAs:["ngxFilePicker"],features:[a.Jb]}),e})(),b=(()=>{class e{}return e.\u0275mod=a.Ub({type:e}),e.\u0275inj=a.Tb({factory:function(t){return new(t||e)},imports:[[]]}),e})();var f=n("LTmD"),p=n("B8lH"),g=n("L99X"),m=n("lEof"),y=n("tk/3");const S=["filePicker"];let v=(()=>{class e{constructor(e,t,n,i,s,o){this.settings=e,this.dbservice=t,this.host=n,this.alertController=i,this.modalController=s,this.http=o,this.readMode=c.arrayBuffer,this.webapp="",this.document="",this.server=""}ngOnInit(){}CleanMemory(e){return Object(l.b)(this,void 0,void 0,(function*(){const t=yield this.alertController.create({header:"\u6e05\u7a7a\u7f13\u5b58",message:"\u53ea\u6e05\u7a7a\u672c\u5730\u7684\u7528\u6237\u6570\u636e\u3002\u53ef\u91cd\u65b0\u4e0b\u8f7d\u5728\u670d\u52a1\u5668\u4fdd\u5b58\u7684\u7528\u6237\u6570\u636e\u548c\u6848\u4f8b\u3002",buttons:[{text:"\u786e\u5b9a",handler:()=>{this.settings.ResetDB(e).then(e=>{this.dbservice.ReloadBooks()})}},{text:"\u53d6\u6d88",role:"cancel",cssClass:"secondary",handler:()=>{}}]});yield t.present()}))}LoadLocalFile(e){const t=e.target.files[0],n=new FileReader;n.onload=()=>{console.log("read file:",n.result);const e=new Uint8Array(n.result),t=new SQL.Database(e).exec("SELECT * From node");console.log(t)},n.readAsArrayBuffer(t)}onReadStart(e){}onFilePicked(e){const t=new Uint8Array(e.content),n=new SQL.Database(t).exec("SELECT * From node");console.log(n)}onReadEnd(e){this.filePicker.reset()}UpdateServer(){this.http.get("https://huaheapp.oss-cn-hangzhou.aliyuncs.com/app/huahe.config.json").subscribe(e=>{const t=e;console.log("new conf",t),console.log("current",this.settings.AppConfig),this.document=t.document,this.webapp=t.website,t.servers.filter(e=>e.version===this.settings.AppConfig.app.version)?console.log("Found Server!!!!!!!!!!!!"):console.log("not found Server!!!!")},e=>{console.log("err",e)})}SettingConfig(e){return Object(l.b)(this,void 0,void 0,(function*(){const t=yield this.modalController.create({component:p.a,componentProps:{SettingComponent:e,Global:!0,OnlyGlobal:!0,Config:"bazi"===e?Object(f.b)(this.settings.Bazi):Object(f.b)(this.settings.Gua)}});yield t.present();const{data:n}=yield t.onWillDismiss();console.log(n)}))}ShowRecord(){return Object(l.b)(this,void 0,void 0,(function*(){let e=!0;const t=yield this.alertController.create({header:"Show Record",inputs:[{name:"keyid",type:"text",label:"Key",value:"*",placeholder:"enter key"}],buttons:[{text:"\u5220\u9664",role:"destructive",handler:()=>{e=!1}},{text:"\u67e5\u770b",role:"cancel",cssClass:"secondary",handler:()=>{}}]});yield t.present();const{data:n}=yield t.onWillDismiss();if(!n)return;const i=n.values.keyid;e?this.settings.ShowData(i.trim()):this.settings.ResetDB(i.trim())}))}UmschreibenBook(){return Object(l.b)(this,void 0,void 0,(function*(){let e=!0;const t=yield this.alertController.create({header:"\u6539\u5199",inputs:[{name:"keyid",type:"text",label:"Key",placeholder:"enter key"}],buttons:[{text:"\u6539\u5199",handler:()=>{e=!1}},{text:"\u53d6\u6d88",role:"cancel",cssClass:"secondary",handler:()=>{}}]});yield t.present();const{data:n}=yield t.onWillDismiss();n&&(e||console.log("test = ",this.dbservice.test(n.values.keyid.trim())))}))}Ticket(){var e,t;return Object(l.b)(this,void 0,void 0,(function*(){let n=!0;const i=this.settings.User,s=yield this.alertController.create({header:"\u62a5\u544a\u95ee\u9898",inputs:[{name:"user",type:"text",label:"\u7528\u6237\u540d",value:null===(e=i)||void 0===e?void 0:e.id,placeholder:"\u7528\u6237\u540d"},{name:"mail",type:"text",label:"\u6ce8\u518c\u90ae\u7bb1",value:null===(t=i)||void 0===t?void 0:t.email,placeholder:"user@mail.com"},{name:"titel",type:"text",label:"\u95ee\u9898",placeholder:"\u4f60\u7684\u95ee\u9898\uff0f\u610f\u89c1"},{name:"comment",type:"text",label:"\u5907\u6ce8",placeholder:"\u5907\u6ce8"}],buttons:[{text:"\u53d1\u9001",handler:()=>{n=!1}},{text:"\u53d6\u6d88",role:"cancel",cssClass:"secondary",handler:()=>{}}]});yield s.present();const{data:o}=yield s.onWillDismiss();console.log(o),o&&o.values&&(o.values.user?o.values.mail?o.values.titel?n||this.host.SendTicket(o.values):this.presentAlert("\u8868\u5355\u9519\u8bef","\u95ee\u9898","\u8bf7\u8f93\u5165\u60a8\u7684\u95ee\u9898\u3002"):this.presentAlert("\u8868\u5355\u9519\u8bef","\u6ce8\u518c\u90ae\u7bb1","\u8bf7\u8f93\u5165\u60a8\u7684\u6ce8\u518c\u90ae\u7bb1, \u5426\u5219\u6211\u4eec\u65e0\u6cd5\u56de\u590d\u3002"):this.presentAlert("\u8868\u5355\u9519\u8bef","\u7528\u6237\u540d","\u8bf7\u8f93\u5165\u60a8\u7684\u7528\u6237\u540d, \u5426\u5219\u6211\u4eec\u65e0\u6cd5\u6838\u5b9e\u8d44\u6599\u3002"))}))}presentAlert(e,t,n){return Object(l.b)(this,void 0,void 0,(function*(){const i=yield this.alertController.create({header:e||"\u9519\u8bef",subHeader:t||"",message:n,buttons:["\u786e\u5b9a"]});yield i.present()}))}}return e.\u0275fac=function(t){return new(t||e)(a.Wb(f.a),a.Wb(g.a),a.Wb(m.a),a.Wb(r.b),a.Wb(r.W),a.Wb(y.b))},e.\u0275cmp=a.Qb({type:e,selectors:[["app-setting"]],viewQuery:function(e,t){var n;1&e&&a.Ac(S,!0),2&e&&a.qc(n=a.ic())&&(t.filePicker=n.first)},decls:38,vars:3,consts:[["slot","start"],["ngxFilePicker","","fill","outline",3,"readMode","readStart","filePick","readEnd"],["filePicker","ngxFilePicker"],["type","file",3,"change"],["fill","outline",3,"click"],["slot","end"],[3,"href"],[3,"click"],["color","danger","fill","outline",3,"click"]],template:function(e,t){1&e&&(a.Zb(0,"ion-header"),a.Zb(1,"ion-toolbar"),a.Zb(2,"ion-buttons",0),a.Xb(3,"ion-menu-button"),a.Yb(),a.Zb(4,"ion-title"),a.xc(5,"\u8bbe\u7f6e"),a.Yb(),a.Yb(),a.Yb(),a.Zb(6,"ion-content"),a.Zb(7,"ion-item"),a.Zb(8,"ion-button",1,2),a.hc("readStart",(function(e){return t.onReadStart(e)}))("filePick",(function(e){return t.onFilePicked(e)}))("readEnd",(function(e){return t.onReadEnd(e)})),a.xc(10,"\u5bfc\u5165\u6848\u4f8b"),a.Yb(),a.Zb(11,"ion-input",3),a.hc("change",(function(e){return t.LoadLocalFile(e)})),a.Yb(),a.Yb(),a.Zb(12,"ion-item"),a.Zb(13,"ion-button",4),a.hc("click",(function(e){return t.UpdateServer()})),a.xc(14,"\u66f4\u65b0\u670d\u52a1\u5730\u5740"),a.Yb(),a.Zb(15,"ion-buttons",5),a.Zb(16,"ion-button",6),a.xc(17,"\u7f51\u9875\u7248APP"),a.Yb(),a.Zb(18,"ion-button",6),a.xc(19,"\u5728\u7ebf\u6587\u6863"),a.Yb(),a.Yb(),a.Yb(),a.Zb(20,"ion-item"),a.Zb(21,"ion-buttons"),a.Zb(22,"ion-button",7),a.hc("click",(function(e){return t.SettingConfig("gua")})),a.xc(23,"\u516d\u723b\u5168\u5c40\u8bbe\u7f6e"),a.Yb(),a.Zb(24,"ion-button",7),a.hc("click",(function(e){return t.SettingConfig("bazi")})),a.xc(25,"\u516b\u5b57\u5168\u5c40\u8bbe\u7f6e"),a.Yb(),a.Yb(),a.Yb(),a.Zb(26,"ion-item"),a.Zb(27,"ion-button",4),a.hc("click",(function(e){return t.Ticket()})),a.xc(28,"\u62a5\u544a\u95ee\u9898"),a.Yb(),a.Yb(),a.Zb(29,"ion-item"),a.Zb(30,"ion-button",8),a.hc("click",(function(e){return t.CleanMemory("recordes")})),a.xc(31,"\u6e05\u7a7a\u6848\u4f8b\u7f13\u5b58"),a.Yb(),a.Zb(32,"ion-button",8),a.hc("click",(function(e){return t.CleanMemory("all")})),a.xc(33,"\u6e05\u7a7a\u7528\u6237\u6570\u636e"),a.Yb(),a.Zb(34,"ion-button",4),a.hc("click",(function(e){return t.ShowRecord()})),a.xc(35,"\u67e5\u770b\uff0f\u5220\u9664"),a.Yb(),a.Zb(36,"ion-button",4),a.hc("click",(function(e){return t.UmschreibenBook()})),a.xc(37,"\u6539\u5199"),a.Yb(),a.Yb(),a.Yb()),2&e&&(a.Mb(8),a.oc("readMode",t.readMode),a.Mb(8),a.oc("href",t.webapp),a.Mb(2),a.oc("href",t.document))},directives:[r.p,r.T,r.i,r.y,r.R,r.l,r.t,r.h,u,r.s,r.cb],styles:[".spin[_ngcontent-%COMP%]{position:fixed;top:50%;left:50%;-webkit-transform:translate(-50%,-50%);transform:translate(-50%,-50%)}ion-spinner[_ngcontent-%COMP%]{width:50px;height:50px;stroke:#444;fill:#222}"]}),e})();var w=n("KPWP");n.d(t,"SettingPageModule",(function(){return x}));const k=[{path:"",component:v}];let x=(()=>{class e{}return e.\u0275mod=a.Ub({type:e}),e.\u0275inj=a.Tb({factory:function(t){return new(t||e)},imports:[[i.b,s.a,r.U,b,w.a,o.i.forChild(k)]]}),e})()},xPBH:function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));class i{constructor(e,t,n=!1){this.Type=e,this.Title=t,this.ShowButton=!0,this.isExpanded=!1,this.isSelected=!1,this.url="",this.sub=[]}static getNodePath(e,t,n=null){var i,s;const o=e?e.Sub:n;if((t||"").IsNullOrEmpty())return["\u6839\u76ee\u5f55"];if((null===(i=e)||void 0===i?void 0:i.ID)===t)return[e.Title];if(!(o.length>0))return null;for(const r of o){const n=this.getNodePath(r,t);if(n)return n.insert(0,(null===(s=e)||void 0===s?void 0:s.Title)||""),n}}get IsFile(){return 32===this.Type}get IsSelected(){return this.isSelected}set IsSelected(e){this.isSelected=e}get IsExpanded(){return this.isExpanded}set IsExpanded(e){0!==this.Sub.length&&(this.isExpanded=e)}get Icon(){switch(this.Type){case 2:return"person";case 4:return"lock";case 8:return"menu";case 16:return"walk";case 32:return"document";case 1:default:return"folder"}}get Url(){return this.url}get Sub(){return this.sub}set Sub(e){this.sub=e}get Color(){return this.isSelected?"tertiary":""}get ColorB(){return this.isSelected?"light":""}SubNodesId(e){e.push(this.ID);for(const t of this.Sub)t.SubNodesId(e)}static get Examples(){const e=[],t=new i(1,"Folder 01"),n=new i(2,"Folder 02"),s=new i(4,"Folder 03"),o=new i(32,"file 01",!0),r=new i(8,"file 02",!0),l=new i(16,"file 03",!0),a=new i(8,"file 04",!0),c=new i(32,"file 05",!0),d=new i(16,"file 06",!0);return t.Sub.push(n),n.Sub.push(o),n.Sub.push(r),n.Sub.push(l),s.Sub.push(a),s.Sub.push(c),s.Sub.push(d),e.push(t),e.push(s),e}}}}]);