function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var n=0,t=new Array(e.length);n<e.length;n++)t[n]=e[n];return t}}function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function _createClass(e,n,t){return n&&_defineProperties(e.prototype,n),t&&_defineProperties(e,t),e}(window.webpackJsonp=window.webpackJsonp||[]).push([[5],{L99X:function(e,n,t){"use strict";t.d(n,"a",(function(){return l}));var o=t("mrSG"),i=t("c7TG"),r=t("LTmD"),c=t("2Vo4"),s=t("Y6BA"),u=(t("xPBH"),t("fXoL")),a=t("e8h1"),d=t("tk/3"),l=function(){var e=function(){function e(n,t,o,i){var r=this;_classCallCheck(this,e),this.settings=n,this.plateform=t,this.storage=o,this.http=i,this.dbReady=new c.a(!1),this.LoadBooks().then((function(e){if(r.nodes=e||[],0===r.Nodes.length)return r.CreateNode(void 0,"\u4e34\u65f6\u6848\u4f8b",32)})).finally((function(){r.dbReady.next(!0)}))}return _createClass(e,[{key:"ReloadBooks",value:function(){var e=this;this.dbReady.next(!1),this.LoadBooks().then((function(n){e.nodes=n||[]})).finally((function(){e.dbReady.next(!0)}))}},{key:"GetAllNodes",value:function(){var e=this;return new Promise((function(n,t){e.DatabaseState.subscribe((function(t){t&&n(e.Nodes)}))}))}},{key:"SaveNodes",value:function(){var n=this,t=this.settings.HasUser?"".concat(e.DB_NODES,"_").concat(this.settings.User.id):e.DB_NODES;return new Promise((function(e,o){var i=JSON.stringify(n.nodes);n.storage.set(t,i).then((function(n){e(!0)})).catch((function(e){o(!1)}))}))}},{key:"CreateNode",value:function(e,n,t){var o=this;return new Promise((function(i,r){var c={id:Object(s.createGuid)(8),created:0,modified:0,parent:e,name:n||"\u4e34\u65f6\u6848\u4f8b",comment:"",type:t||1,size:0,sync:0};o.nodes=o.nodes||[],o.nodes.push(c),o.SaveNodes().then((function(e){i(o.Nodes)})).catch((function(e){r(e)}))}))}},{key:"ChangeNode",value:function(e,n){var t=this,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return new Promise((function(i,r){var c=t.nodes.where((function(n){return n.id===e}));if(c&&1===c.length){var s=c[0];s.name=n||s.name,s.parent=o||s.parent,t.SaveNodes().then((function(e){i(t.Nodes)})).catch((function(e){r(!1)}))}}))}},{key:"DeleteNodes",value:function(e){var n=this,t=Date.now();return new Promise((function(o,i){var r=[];n.nodes.forEach((function(n){e.includes(n.id)&&(n.size=-1,n.modified=t,32===n.type&&r.push(n.id))})),n.SaveNodes().then((function(e){o(n.Nodes)})).catch((function(e){i(!1)}))}))}},{key:"SyncNodes",value:function(e){var n=this,t=this.nodes.map((function(e){return e.id})),o=[],i=[];return e.forEach((function(e){if(t.includes(e.id)){if(n.nodes.find((function(n){return n.id===e.id})).modified<e.modified){var i=n.nodes.findIndex((function(n){return n.id===e.id}));n.nodes.splice(i,1,Object(r.b)(e)),o.push(e.id)}}else n.nodes.push(Object(r.b)(e)),o.push(e.id)})),this.CleanNodes(),this.nodes.forEach((function(n){var t=e.find((function(e){return e.id===n.id}));n.name.startsWith("\u516d\u723b")&&console.log("...",t,n),(!t||t.modified<n.modified)&&i.push(n.id)})),o.length>0?(console.log("new Booktree will be saved.",this.nodes),this.SaveNodes().then((function(){return[o,i]}))):Promise.resolve([o,i])}},{key:"CleanNodes",value:function(){var e=Date.now()-2592e6;this.nodes=this.nodes.filter((function(n){return n.size<0&&n.modified<e||n.size>=0}))}},{key:"GetRecordes",value:function(e){var n=this;return new Promise((function(t,o){n.storage.get("Book_".concat(e)).then((function(i){if(i){var r=JSON.parse(i);t(r.filter((function(e){return e.size>=0})))}else 0===n.Nodes.find((function(n){return n.id===e})).sync?(n.SaveRecordes(e,[]),t([])):o([])})).catch((function(e){o(e)}))}))}},{key:"SaveRecordes",value:function(e,n){var t=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];console.log("save recordes of ",e);var o=JSON.stringify(n);if(this.storage.set("Book_".concat(e),o),t){var i=this.nodes.find((function(n){return n.id===e}));i.created=0===i.created?Date.now():i.created,i.modified=Date.now(),i.size=o.length,this.SaveNodes()}}},{key:"CreateRecord",value:function(e,n,t,o){return{id:Object(s.createGuid)(8),node:e,created:Date.now(),modified:Date.now(),type:t,titel:n,arg:o,content:"",size:0,sync:0}}},{key:"SaveRecord",value:function(e,n,t,o){var i=this;return new Promise((function(r,c){i.storage.get("Book_".concat(e)).then((function(c){var s=JSON.parse(c),u=i.CreateRecord(e,n,t,o);s.push(u),i.SaveRecordes(e,s),r(u)}))}))}},{key:"DeleteRecordes",value:function(e,n){var t=this;return new Promise((function(o,i){t.storage.get("Book_".concat(e)).then((function(i){var r=JSON.parse(i);r.forEach((function(e){n.includes(e.id)&&(e.size=-1,e.content="",e.arg="",e.modified=Date.now())})),t.SaveRecordes(e,r),o(r.filter((function(e){return e.size>=0})))}))}))}},{key:"MoveRecordes",value:function(e,n,t){var o=this;return new Promise((function(i,r){var c=o.storage.get("Book_".concat(e)).then((function(e){return JSON.parse(e)||[]})),s=o.storage.get("Book_".concat(n)).then((function(e){return JSON.parse(e)||[]}));Promise.all([c,s]).then((function(r){var c=r[0],s=r[1],u=!0,a=!1,d=void 0;try{for(var l,f=function(){var e=l.value,t=c.find((function(n){return n.id===e}));t.node=n,s.push(t),c=c.filter((function(n){return n.id!==e}))},h=t[Symbol.iterator]();!(u=(l=h.next()).done);u=!0)f()}catch(b){a=!0,d=b}finally{try{u||null==h.return||h.return()}finally{if(a)throw d}}console.log("move finish",c,s,t),o.SaveRecordes(e,c),o.SaveRecordes(n,s),i(c.filter((function(e){return e.size>=0})))}))}))}},{key:"ChangeBooktreeOfAnonym",value:function(n){var t=this,o="".concat(e.DB_NODES,"_").concat(n);return this.storage.keys().then((function(n){return n.includes(o)?Promise.reject("".concat(o," is already hier.")):t.storage.get(e.DB_NODES)})).then((function(e){return e?(console.log("umschreiben booktree to ",o),t.storage.set("".concat(o),e)):Promise.reject("booktree can not founde.")})).then((function(){return console.log("umschreiben erfolg!"),t.storage.remove(e.DB_NODES)})).then((function(){return console.log("Record ".concat(e.DB_NODES," will deleted")),!0})).catch((function(e){return console.log("ChangeBooktreeOfAnonym denied: ",e),!1}))}},{key:"test",value:function(e){var n=this;return this.storage.get("...").then((function(t){return console.log("get ...",t),n.storage.get(e)})).then((function(n){return console.log("get ".concat(e),n),Promise.resolve(!0)}))}},{key:"WaitInit",value:function(){var e=this;return new Promise((function(n,t){e.DatabaseState.subscribe((function(e){e&&n(!0)}))}))}},{key:"LoadBooks",value:function(){return Object(o.b)(this,void 0,void 0,regeneratorRuntime.mark((function n(){var t;return regeneratorRuntime.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,this.settings.WaitInit();case 2:return t=this.settings.HasUser?"".concat(e.DB_NODES,"_").concat(this.settings.User.id):e.DB_NODES,n.abrupt("return",(console.log("loadbooks of ".concat(t)),this.storage.get(t).then((function(e){return Promise.resolve(Object(r.d)(e))})).catch((function(e){return console.error("LoadBooks() error:",e),Promise.resolve([])}))));case 4:case"end":return n.stop()}}),n,this)})))}},{key:"DatabaseState",get:function(){return this.dbReady.asObservable()}},{key:"Nodes",get:function(){return this.nodes.filter((function(e){return e.size>=0}))}},{key:"NodesAlle",get:function(){return this.nodes}},{key:"NodeModified",get:function(){return Math.max.apply(Math,_toConsumableArray(this.nodes.map((function(e){return e.modified}))))}}]),e}();return e.DB_NODES="booktree",e.\u0275fac=function(n){return new(n||e)(u.dc(r.a),u.dc(i.Y),u.dc(a.b),u.dc(d.b))},e.\u0275prov=u.Sb({token:e,factory:e.\u0275fac,providedIn:"root"}),e}()},mo90:function(e,n,t){"use strict";t.d(n,"a",(function(){return d}));var o=t("L99X"),i=t("xPBH"),r=t("c7TG"),c=t("fXoL"),s=t("ofXK"),u=t("vBXD");function a(e,n){if(1&e&&(c.Zb(0,"ion-item"),c.Zb(1,"ion-text"),c.xc(2,"\u539f\u76ee\u5f55\uff1a"),c.Yb(),c.Zb(3,"ion-text",5),c.xc(4),c.Yb(),c.Yb()),2&e){var t=c.jc();c.Mb(4),c.yc(t.From)}}var d=function(){var e=function(){function e(n,t){_classCallCheck(this,e),this.dbservice=n,this.modalCtrl=t,this.NodeID="",this.SelectDocument=!1,this.SelectedNode=null,this.To="\u6839\u76ee\u5f55",this.From=""}return _createClass(e,[{key:"ngOnInit",value:function(){var e=this;console.log("Titel=".concat(this.Titel)),this.dbservice.GetAllNodes().then((function(n){e.Nodes=e.buildNodeTree(n,null),e.From=e.NodeID.IsNullOrEmpty()?"":i.a.getNodePath(null,e.NodeID,e.Nodes).join("/")}))}},{key:"onclose",value:function(e){var n,t={};e&&(t={nodeid:(null===(n=this.SelectedNode)||void 0===n?void 0:n.ID)||""}),this.modalCtrl.dismiss(t)}},{key:"onNodeSelecte",value:function(e){this.SelectDocument&&!e.IsFile||!this.SelectDocument&&e.IsFile||e.ID!==this.NodeID&&(e.Sub.select((function(e){return e.ID})).includes(this.NodeID)||(this.SelectedNode&&(this.SelectedNode.IsSelected=!1),e!==this.SelectedNode&&e&&(this.SelectedNode=e,this.SelectedNode.IsSelected=!0,this.To=i.a.getNodePath(null,this.SelectedNode.ID,this.Nodes).join("/"))))}},{key:"restore",value:function(){this.To="\u6839\u76ee\u5f55",this.SelectedNode&&(this.SelectedNode.IsSelected=!1,this.SelectedNode=null)}},{key:"buildNodeTree",value:function(e,n){var t=this,o=[];return(n||"").IsNullOrEmpty(),n=null!=n?n:"",(o=e.where((function(e){return(e.parent||"")===n})).sortByKey("created").select((function(e){var n=new i.a(e.type,e.name);return n.ID=e.id||null,n.ShowButton=!1,n}))).forEach((function(n){n.Sub=t.buildNodeTree(e,n.ID)})),o}}]),e}();return e.\u0275fac=function(n){return new(n||e)(c.Wb(o.a),c.Wb(r.W))},e.\u0275cmp=c.Qb({type:e,selectors:[["app-picknode"]],inputs:{Titel:"Titel",NodeID:"NodeID",SelectDocument:"SelectDocument"},decls:21,vars:4,consts:[["color","secondary"],["slot","start"],[3,"click"],["slot","end"],[4,"ngIf"],["color","medium"],["slot","end",3,"click"],["name","md-backspace"],[3,"nodes","nodeSelected"]],template:function(e,n){1&e&&(c.Zb(0,"ion-header"),c.Zb(1,"ion-toolbar",0),c.Zb(2,"ion-buttons",1),c.Zb(3,"ion-button",2),c.hc("click",(function(e){return n.onclose(!1)})),c.xc(4," \u53d6\u6d88 "),c.Yb(),c.Yb(),c.Zb(5,"ion-title"),c.xc(6),c.Yb(),c.Zb(7,"ion-buttons",3),c.Zb(8,"ion-button",2),c.hc("click",(function(e){return n.onclose(!0)})),c.xc(9," \u786e\u5b9a "),c.Yb(),c.Yb(),c.Yb(),c.Yb(),c.Zb(10,"ion-content"),c.Zb(11,"ion-list"),c.wc(12,a,5,1,"ion-item",4),c.Zb(13,"ion-item"),c.Zb(14,"ion-text"),c.xc(15,"\u76ee\u6807\u76ee\u5f55\uff1a"),c.Yb(),c.Zb(16,"ion-text",5),c.xc(17),c.Yb(),c.Zb(18,"ion-button",6),c.hc("click",(function(e){return n.restore()})),c.Xb(19,"ion-icon",7),c.Yb(),c.Yb(),c.Zb(20,"app-tree-node",8),c.hc("nodeSelected",(function(e){return n.onNodeSelecte(e)})),c.Yb(),c.Yb(),c.Yb()),2&e&&(c.Mb(6),c.yc(n.Titel),c.Mb(6),c.oc("ngIf",""!==n.From),c.Mb(5),c.yc(n.To),c.Mb(3),c.oc("nodes",n.Nodes))},directives:[r.p,r.T,r.i,r.h,r.R,r.l,r.v,s.j,r.t,r.O,r.q,u.a],styles:[""]}),e}()},vBXD:function(e,n,t){"use strict";t.d(n,"a",(function(){return h}));var o=t("mrSG"),i=t("fXoL"),r=t("ofXK"),c=t("c7TG");function s(e,n){if(1&e&&i.Xb(0,"ion-icon",9),2&e){var t=i.jc().$implicit;i.oc("color",t.IsExpanded?"primary":"gray")("name",t.IsExpanded?"ios-arrow-down":"ios-arrow-up")}}function u(e,n){if(1&e&&i.Xb(0,"ion-icon",10),2&e){var t=i.jc().$implicit;i.oc("name",t.Icon)}}function a(e,n){if(1&e){var t=i.ac();i.Zb(0,"ion-button",11),i.hc("click",(function(e){i.rc(t);var n=i.jc().$implicit;return i.jc().CreateNode(n)})),i.Xb(1,"ion-icon",12),i.Zb(2,"ion-text"),i.xc(3,"\u5b50\u76ee\u5f55"),i.Yb(),i.Yb()}if(2&e){var o=i.jc().$implicit;i.oc("hidden",!o.IsSelected||!o.ShowButton)}}function d(e,n){if(1&e){var t=i.ac();i.Zb(0,"app-tree-node",13),i.hc("nodeSelected",(function(e){return i.rc(t),i.jc(2).onSubNodeSelecte(e)}))("nodeAdd",(function(e){return i.rc(t),i.jc(2).onSubNodeAdd(e)})),i.Yb()}if(2&e){var o=i.jc().$implicit;i.oc("nodes",o.Sub)("hidden",!o.IsExpanded)}}var l=function(e){return{active:e}};function f(e,n){if(1&e){var t=i.ac();i.Zb(0,"div",1),i.Zb(1,"ion-item",2),i.hc("click",(function(e){i.rc(t);var o=n.$implicit,r=i.jc();return o.IsExpanded=!o.IsExpanded,r.clickNode(o)})),i.Zb(2,"span",3),i.wc(3,s,1,2,"ion-icon",4),i.Yb(),i.wc(4,u,1,1,"ion-icon",5),i.Zb(5,"ion-text",6),i.xc(6),i.Yb(),i.wc(7,a,4,1,"ion-button",7),i.Yb(),i.wc(8,d,1,2,"app-tree-node",8),i.Yb()}if(2&e){var o=n.$implicit;i.Mb(1),i.oc("ngClass",i.pc(8,l,o.IsExpanded))("color",o.ColorB),i.Mb(2),i.oc("ngIf",!o.IsFile&&o.Sub.length>0),i.Mb(1),i.oc("ngIf",o.Icon),i.Mb(1),i.oc("color",o.Color),i.Mb(1),i.yc(o.Title),i.Mb(1),i.oc("ngIf",32!==o.Type),i.Mb(1),i.oc("ngIf",o.Sub.length>0)}}var h=function(){var e=function(){function e(){_classCallCheck(this,e),this.nodeSelected=new i.s,this.nodeAdd=new i.s}return _createClass(e,[{key:"ngOnInit",value:function(){}},{key:"clickNode",value:function(e){this.nodeSelected.emit(e)}},{key:"onSubNodeSelecte",value:function(e){this.nodeSelected.emit(e)}},{key:"CreateNode",value:function(e){return Object(o.b)(this,void 0,void 0,regeneratorRuntime.mark((function n(){return regeneratorRuntime.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:this.nodeAdd.emit(e);case 1:case"end":return n.stop()}}),n,this)})))}},{key:"onSubNodeAdd",value:function(e){this.nodeAdd.emit(e)}}]),e}();return e.\u0275fac=function(n){return new(n||e)},e.\u0275cmp=i.Qb({type:e,selectors:[["app-tree-node"]],inputs:{nodes:"nodes"},outputs:{nodeSelected:"nodeSelected",nodeAdd:"nodeAdd"},decls:1,vars:1,consts:[["class","divitem",4,"ngFor","ngForOf"],[1,"divitem"],["detail","false","lines","none",3,"ngClass","color","click"],[1,"spanCursor"],["slot","start",3,"color","name",4,"ngIf"],["class","iconNode","color","dark",3,"name",4,"ngIf"],[3,"color"],["slot","end",3,"hidden","click",4,"ngIf"],[3,"nodes","hidden","nodeSelected","nodeAdd",4,"ngIf"],["slot","start",3,"color","name"],["color","dark",1,"iconNode",3,"name"],["slot","end",3,"hidden","click"],["name","add"],[3,"nodes","hidden","nodeSelected","nodeAdd"]],template:function(e,n){1&e&&i.wc(0,f,9,10,"div",0),2&e&&i.oc("ngForOf",n.nodes)},directives:[r.i,c.t,r.h,r.j,c.O,c.q,c.h,e],styles:[".spanCursor[_ngcontent-%COMP%]{min-width:1em}.divitem[_ngcontent-%COMP%]{padding:0 0 0 15px;margin:0}.iconNode[_ngcontent-%COMP%]{margin-right:.5em}.selectedNode[_ngcontent-%COMP%]{background-color:#5f9ea0}"]}),e}()},xPBH:function(e,n,t){"use strict";t.d(n,"a",(function(){return o}));var o=function(){function e(n,t){arguments.length>2&&void 0!==arguments[2]&&arguments[2];_classCallCheck(this,e),this.Type=n,this.Title=t,this.ShowButton=!0,this.isExpanded=!1,this.isSelected=!1,this.url="",this.sub=[]}return _createClass(e,[{key:"SubNodesId",value:function(e){e.push(this.ID);var n=!0,t=!1,o=void 0;try{for(var i,r=this.Sub[Symbol.iterator]();!(n=(i=r.next()).done);n=!0){i.value.SubNodesId(e)}}catch(c){t=!0,o=c}finally{try{n||null==r.return||r.return()}finally{if(t)throw o}}}},{key:"IsFile",get:function(){return 32===this.Type}},{key:"IsSelected",get:function(){return this.isSelected},set:function(e){this.isSelected=e}},{key:"IsExpanded",get:function(){return this.isExpanded},set:function(e){0!==this.Sub.length&&(this.isExpanded=e)}},{key:"Icon",get:function(){switch(this.Type){case 2:return"person";case 4:return"lock";case 8:return"menu";case 16:return"walk";case 32:return"document";case 1:default:return"folder"}}},{key:"Url",get:function(){return this.url}},{key:"Sub",get:function(){return this.sub},set:function(e){this.sub=e}},{key:"Color",get:function(){return this.isSelected?"tertiary":""}},{key:"ColorB",get:function(){return this.isSelected?"light":""}}],[{key:"getNodePath",value:function(e,n){var t,o,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=e?e.Sub:i;if((n||"").IsNullOrEmpty())return["\u6839\u76ee\u5f55"];if((null===(t=e)||void 0===t?void 0:t.ID)===n)return[e.Title];if(!(r.length>0))return null;var c=!0,s=!1,u=void 0;try{for(var a,d=r[Symbol.iterator]();!(c=(a=d.next()).done);c=!0){var l=a.value,f=this.getNodePath(l,n);if(f)return f.insert(0,(null===(o=e)||void 0===o?void 0:o.Title)||""),f}}catch(h){s=!0,u=h}finally{try{c||null==d.return||d.return()}finally{if(s)throw u}}}},{key:"Examples",get:function(){var n=[],t=new e(1,"Folder 01"),o=new e(2,"Folder 02"),i=new e(4,"Folder 03"),r=new e(32,"file 01",!0),c=new e(8,"file 02",!0),s=new e(16,"file 03",!0),u=new e(8,"file 04",!0),a=new e(32,"file 05",!0),d=new e(16,"file 06",!0);return t.Sub.push(o),o.Sub.push(r),o.Sub.push(c),o.Sub.push(s),i.Sub.push(u),i.Sub.push(a),i.Sub.push(d),n.push(t),n.push(i),n}}]),e}()}}]);