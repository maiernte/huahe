(window.webpackJsonp=window.webpackJsonp||[]).push([[5],{L99X:function(e,t,o){"use strict";o.d(t,"a",(function(){return a}));var n=o("mrSG"),s=o("c7TG"),i=o("LTmD"),d=o("2Vo4"),c=o("Y6BA"),r=(o("xPBH"),o("fXoL")),l=o("e8h1"),h=o("tk/3");let a=(()=>{class e{constructor(e,t,o,n){this.settings=e,this.plateform=t,this.storage=o,this.http=n,this.dbReady=new d.a(!1),this.LoadBooks().then(e=>{if(this.nodes=e||[],0===this.Nodes.length)return this.CreateNode(void 0,"\u4e34\u65f6\u6848\u4f8b",32)}).finally(()=>{this.dbReady.next(!0)})}ReloadBooks(){this.dbReady.next(!1),this.LoadBooks().then(e=>{this.nodes=e||[]}).finally(()=>{this.dbReady.next(!0)})}get DatabaseState(){return this.dbReady.asObservable()}get Nodes(){return this.nodes.filter(e=>e.size>=0)}get NodesAlle(){return this.nodes}get NodeModified(){return Math.max(...this.nodes.map(e=>e.modified))}GetAllNodes(){return new Promise((e,t)=>{this.DatabaseState.subscribe(t=>{t&&e(this.Nodes)})})}SaveNodes(){const t=this.settings.HasUser?`${e.DB_NODES}_${this.settings.User.id}`:e.DB_NODES;return new Promise((e,o)=>{const n=JSON.stringify(this.nodes);this.storage.set(t,n).then(t=>{e(!0)}).catch(e=>{o(!1)})})}CreateNode(e,t,o){return new Promise((n,s)=>{const i={id:Object(c.createGuid)(8),created:0,modified:0,parent:e,name:t||"\u4e34\u65f6\u6848\u4f8b",comment:"",type:o||1,size:0,sync:0};this.nodes=this.nodes||[],this.nodes.push(i),this.SaveNodes().then(e=>{n(this.Nodes)}).catch(e=>{s(e)})})}ChangeNode(e,t,o=null){return new Promise((n,s)=>{const i=this.nodes.where(t=>t.id===e);if(i&&1===i.length){const e=i[0];e.name=t||e.name,e.parent=o||e.parent,this.SaveNodes().then(e=>{n(this.Nodes)}).catch(e=>{s(!1)})}})}DeleteNodes(e){const t=Date.now();return new Promise((o,n)=>{const s=[];this.nodes.forEach(o=>{e.includes(o.id)&&(o.size=-1,o.modified=t,32===o.type&&s.push(o.id))}),this.SaveNodes().then(e=>{o(this.Nodes)}).catch(e=>{n(!1)})})}SyncNodes(e){const t=this.nodes.map(e=>e.id),o=[],n=[];return e.forEach(e=>{if(t.includes(e.id)){if(this.nodes.find(t=>t.id===e.id).modified<e.modified){const t=this.nodes.findIndex(t=>t.id===e.id);this.nodes.splice(t,1,Object(i.b)(e)),o.push(e.id)}}else this.nodes.push(Object(i.b)(e)),o.push(e.id)}),this.CleanNodes(),this.nodes.forEach(t=>{const o=e.find(e=>e.id===t.id);t.name.startsWith("\u516d\u723b")&&console.log("...",o,t),(!o||o.modified<t.modified)&&n.push(t.id)}),o.length>0?(console.log("new Booktree will be saved.",this.nodes),this.SaveNodes().then(()=>[o,n])):Promise.resolve([o,n])}CleanNodes(){const e=Date.now()-2592e6;this.nodes=this.nodes.filter(t=>t.size<0&&t.modified<e||t.size>=0)}GetRecordes(e){return new Promise((t,o)=>{this.storage.get(`Book_${e}`).then(n=>{if(n){const e=JSON.parse(n);t(e.filter(e=>e.size>=0))}else 0===this.Nodes.find(t=>t.id===e).sync?(this.SaveRecordes(e,[]),t([])):o([])}).catch(e=>{o(e)})})}SaveRecordes(e,t,o=!0){console.log("save recordes of ",e);const n=JSON.stringify(t);if(this.storage.set(`Book_${e}`,n),o){const t=this.nodes.find(t=>t.id===e);t.created=0===t.created?Date.now():t.created,t.modified=Date.now(),t.size=n.length,this.SaveNodes()}}CreateRecord(e,t,o,n){return{id:Object(c.createGuid)(8),node:e,created:Date.now(),modified:Date.now(),type:o,titel:t,arg:n,content:"",size:0,sync:0}}SaveRecord(e,t,o,n){return new Promise((s,i)=>{this.storage.get(`Book_${e}`).then(i=>{const d=JSON.parse(i),c=this.CreateRecord(e,t,o,n);d.push(c),this.SaveRecordes(e,d),s(c)})})}DeleteRecordes(e,t){return new Promise((o,n)=>{this.storage.get(`Book_${e}`).then(n=>{const s=JSON.parse(n);s.forEach(e=>{t.includes(e.id)&&(e.size=-1,e.content="",e.arg="",e.modified=Date.now())}),this.SaveRecordes(e,s),o(s.filter(e=>e.size>=0))})})}MoveRecordes(e,t,o){return new Promise((n,s)=>{const i=this.storage.get(`Book_${e}`).then(e=>JSON.parse(e)||[]),d=this.storage.get(`Book_${t}`).then(e=>JSON.parse(e)||[]);Promise.all([i,d]).then(s=>{let i=s[0];const d=s[1];for(const e of o){const o=i.find(t=>t.id===e);o.node=t,d.push(o),i=i.filter(t=>t.id!==e)}console.log("move finish",i,d,o),this.SaveRecordes(e,i),this.SaveRecordes(t,d),n(i.filter(e=>e.size>=0))})})}ChangeBooktreeOfAnonym(t){const o=`${e.DB_NODES}_${t}`;return this.storage.keys().then(t=>t.includes(o)?Promise.reject(`${o} is already hier.`):this.storage.get(e.DB_NODES)).then(e=>e?(console.log("umschreiben booktree to ",o),this.storage.set(`${o}`,e)):Promise.reject("booktree can not founde.")).then(()=>(console.log("umschreiben erfolg!"),this.storage.remove(e.DB_NODES))).then(()=>(console.log(`Record ${e.DB_NODES} will deleted`),!0)).catch(e=>(console.log("ChangeBooktreeOfAnonym denied: ",e),!1))}test(e){return this.storage.get("...").then(t=>(console.log("get ...",t),this.storage.get(e))).then(t=>(console.log(`get ${e}`,t),Promise.resolve(!0)))}WaitInit(){return new Promise((e,t)=>{this.DatabaseState.subscribe(t=>{t&&e(!0)})})}LoadBooks(){return Object(n.b)(this,void 0,void 0,(function*(){yield this.settings.WaitInit();const t=this.settings.HasUser?`${e.DB_NODES}_${this.settings.User.id}`:e.DB_NODES;return console.log(`loadbooks of ${t}`),this.storage.get(t).then(e=>Promise.resolve(Object(i.d)(e))).catch(e=>(console.error("LoadBooks() error:",e),Promise.resolve([])))}))}}return e.DB_NODES="booktree",e.\u0275fac=function(t){return new(t||e)(r.dc(i.a),r.dc(s.Y),r.dc(l.b),r.dc(h.b))},e.\u0275prov=r.Sb({token:e,factory:e.\u0275fac,providedIn:"root"}),e})()},mo90:function(e,t,o){"use strict";o.d(t,"a",(function(){return h}));var n=o("L99X"),s=o("xPBH"),i=o("c7TG"),d=o("fXoL"),c=o("ofXK"),r=o("vBXD");function l(e,t){if(1&e&&(d.Zb(0,"ion-item"),d.Zb(1,"ion-text"),d.xc(2,"\u539f\u76ee\u5f55\uff1a"),d.Yb(),d.Zb(3,"ion-text",5),d.xc(4),d.Yb(),d.Yb()),2&e){const e=d.jc();d.Mb(4),d.yc(e.From)}}let h=(()=>{class e{constructor(e,t){this.dbservice=e,this.modalCtrl=t,this.NodeID="",this.SelectDocument=!1,this.SelectedNode=null,this.To="\u6839\u76ee\u5f55",this.From=""}ngOnInit(){console.log(`Titel=${this.Titel}`),this.dbservice.GetAllNodes().then(e=>{this.Nodes=this.buildNodeTree(e,null),this.From=this.NodeID.IsNullOrEmpty()?"":s.a.getNodePath(null,this.NodeID,this.Nodes).join("/")})}onclose(e){var t;let o={};e&&(o={nodeid:(null===(t=this.SelectedNode)||void 0===t?void 0:t.ID)||""}),this.modalCtrl.dismiss(o)}onNodeSelecte(e){this.SelectDocument&&!e.IsFile||!this.SelectDocument&&e.IsFile||e.ID!==this.NodeID&&(e.Sub.select(e=>e.ID).includes(this.NodeID)||(this.SelectedNode&&(this.SelectedNode.IsSelected=!1),e!==this.SelectedNode&&e&&(this.SelectedNode=e,this.SelectedNode.IsSelected=!0,this.To=s.a.getNodePath(null,this.SelectedNode.ID,this.Nodes).join("/"))))}restore(){this.To="\u6839\u76ee\u5f55",this.SelectedNode&&(this.SelectedNode.IsSelected=!1,this.SelectedNode=null)}buildNodeTree(e,t){let o=[];return(t||"").IsNullOrEmpty(),t=null!=t?t:"",o=e.where(e=>(e.parent||"")===t).sortByKey("created").select(e=>{const t=new s.a(e.type,e.name);return t.ID=e.id||null,t.ShowButton=!1,t}),o.forEach(t=>{t.Sub=this.buildNodeTree(e,t.ID)}),o}}return e.\u0275fac=function(t){return new(t||e)(d.Wb(n.a),d.Wb(i.W))},e.\u0275cmp=d.Qb({type:e,selectors:[["app-picknode"]],inputs:{Titel:"Titel",NodeID:"NodeID",SelectDocument:"SelectDocument"},decls:21,vars:4,consts:[["color","secondary"],["slot","start"],[3,"click"],["slot","end"],[4,"ngIf"],["color","medium"],["slot","end",3,"click"],["name","md-backspace"],[3,"nodes","nodeSelected"]],template:function(e,t){1&e&&(d.Zb(0,"ion-header"),d.Zb(1,"ion-toolbar",0),d.Zb(2,"ion-buttons",1),d.Zb(3,"ion-button",2),d.hc("click",(function(e){return t.onclose(!1)})),d.xc(4," \u53d6\u6d88 "),d.Yb(),d.Yb(),d.Zb(5,"ion-title"),d.xc(6),d.Yb(),d.Zb(7,"ion-buttons",3),d.Zb(8,"ion-button",2),d.hc("click",(function(e){return t.onclose(!0)})),d.xc(9," \u786e\u5b9a "),d.Yb(),d.Yb(),d.Yb(),d.Yb(),d.Zb(10,"ion-content"),d.Zb(11,"ion-list"),d.wc(12,l,5,1,"ion-item",4),d.Zb(13,"ion-item"),d.Zb(14,"ion-text"),d.xc(15,"\u76ee\u6807\u76ee\u5f55\uff1a"),d.Yb(),d.Zb(16,"ion-text",5),d.xc(17),d.Yb(),d.Zb(18,"ion-button",6),d.hc("click",(function(e){return t.restore()})),d.Xb(19,"ion-icon",7),d.Yb(),d.Yb(),d.Zb(20,"app-tree-node",8),d.hc("nodeSelected",(function(e){return t.onNodeSelecte(e)})),d.Yb(),d.Yb(),d.Yb()),2&e&&(d.Mb(6),d.yc(t.Titel),d.Mb(6),d.oc("ngIf",""!==t.From),d.Mb(5),d.yc(t.To),d.Mb(3),d.oc("nodes",t.Nodes))},directives:[i.p,i.T,i.i,i.h,i.R,i.l,i.v,c.j,i.t,i.O,i.q,r.a],styles:[""]}),e})()},vBXD:function(e,t,o){"use strict";o.d(t,"a",(function(){return b}));var n=o("mrSG"),s=o("fXoL"),i=o("ofXK"),d=o("c7TG");function c(e,t){if(1&e&&s.Xb(0,"ion-icon",9),2&e){const e=s.jc().$implicit;s.oc("color",e.IsExpanded?"primary":"gray")("name",e.IsExpanded?"ios-arrow-down":"ios-arrow-up")}}function r(e,t){if(1&e&&s.Xb(0,"ion-icon",10),2&e){const e=s.jc().$implicit;s.oc("name",e.Icon)}}function l(e,t){if(1&e){const e=s.ac();s.Zb(0,"ion-button",11),s.hc("click",(function(t){s.rc(e);const o=s.jc().$implicit;return s.jc().CreateNode(o)})),s.Xb(1,"ion-icon",12),s.Zb(2,"ion-text"),s.xc(3,"\u5b50\u76ee\u5f55"),s.Yb(),s.Yb()}if(2&e){const e=s.jc().$implicit;s.oc("hidden",!e.IsSelected||!e.ShowButton)}}function h(e,t){if(1&e){const e=s.ac();s.Zb(0,"app-tree-node",13),s.hc("nodeSelected",(function(t){return s.rc(e),s.jc(2).onSubNodeSelecte(t)}))("nodeAdd",(function(t){return s.rc(e),s.jc(2).onSubNodeAdd(t)})),s.Yb()}if(2&e){const e=s.jc().$implicit;s.oc("nodes",e.Sub)("hidden",!e.IsExpanded)}}const a=function(e){return{active:e}};function u(e,t){if(1&e){const e=s.ac();s.Zb(0,"div",1),s.Zb(1,"ion-item",2),s.hc("click",(function(o){s.rc(e);const n=t.$implicit,i=s.jc();return n.IsExpanded=!n.IsExpanded,i.clickNode(n)})),s.Zb(2,"span",3),s.wc(3,c,1,2,"ion-icon",4),s.Yb(),s.wc(4,r,1,1,"ion-icon",5),s.Zb(5,"ion-text",6),s.xc(6),s.Yb(),s.wc(7,l,4,1,"ion-button",7),s.Yb(),s.wc(8,h,1,2,"app-tree-node",8),s.Yb()}if(2&e){const e=t.$implicit;s.Mb(1),s.oc("ngClass",s.pc(8,a,e.IsExpanded))("color",e.ColorB),s.Mb(2),s.oc("ngIf",!e.IsFile&&e.Sub.length>0),s.Mb(1),s.oc("ngIf",e.Icon),s.Mb(1),s.oc("color",e.Color),s.Mb(1),s.yc(e.Title),s.Mb(1),s.oc("ngIf",32!==e.Type),s.Mb(1),s.oc("ngIf",e.Sub.length>0)}}let b=(()=>{class e{constructor(){this.nodeSelected=new s.s,this.nodeAdd=new s.s}ngOnInit(){}clickNode(e){this.nodeSelected.emit(e)}onSubNodeSelecte(e){this.nodeSelected.emit(e)}CreateNode(e){return Object(n.b)(this,void 0,void 0,(function*(){this.nodeAdd.emit(e)}))}onSubNodeAdd(e){this.nodeAdd.emit(e)}}return e.\u0275fac=function(t){return new(t||e)},e.\u0275cmp=s.Qb({type:e,selectors:[["app-tree-node"]],inputs:{nodes:"nodes"},outputs:{nodeSelected:"nodeSelected",nodeAdd:"nodeAdd"},decls:1,vars:1,consts:[["class","divitem",4,"ngFor","ngForOf"],[1,"divitem"],["detail","false","lines","none",3,"ngClass","color","click"],[1,"spanCursor"],["slot","start",3,"color","name",4,"ngIf"],["class","iconNode","color","dark",3,"name",4,"ngIf"],[3,"color"],["slot","end",3,"hidden","click",4,"ngIf"],[3,"nodes","hidden","nodeSelected","nodeAdd",4,"ngIf"],["slot","start",3,"color","name"],["color","dark",1,"iconNode",3,"name"],["slot","end",3,"hidden","click"],["name","add"],[3,"nodes","hidden","nodeSelected","nodeAdd"]],template:function(e,t){1&e&&s.wc(0,u,9,10,"div",0),2&e&&s.oc("ngForOf",t.nodes)},directives:[i.i,d.t,i.h,i.j,d.O,d.q,d.h,e],styles:[".spanCursor[_ngcontent-%COMP%]{min-width:1em}.divitem[_ngcontent-%COMP%]{padding:0 0 0 15px;margin:0}.iconNode[_ngcontent-%COMP%]{margin-right:.5em}.selectedNode[_ngcontent-%COMP%]{background-color:#5f9ea0}"]}),e})()},xPBH:function(e,t,o){"use strict";o.d(t,"a",(function(){return n}));class n{constructor(e,t,o=!1){this.Type=e,this.Title=t,this.ShowButton=!0,this.isExpanded=!1,this.isSelected=!1,this.url="",this.sub=[]}static getNodePath(e,t,o=null){var n,s;const i=e?e.Sub:o;if((t||"").IsNullOrEmpty())return["\u6839\u76ee\u5f55"];if((null===(n=e)||void 0===n?void 0:n.ID)===t)return[e.Title];if(!(i.length>0))return null;for(const d of i){const o=this.getNodePath(d,t);if(o)return o.insert(0,(null===(s=e)||void 0===s?void 0:s.Title)||""),o}}get IsFile(){return 32===this.Type}get IsSelected(){return this.isSelected}set IsSelected(e){this.isSelected=e}get IsExpanded(){return this.isExpanded}set IsExpanded(e){0!==this.Sub.length&&(this.isExpanded=e)}get Icon(){switch(this.Type){case 2:return"person";case 4:return"lock";case 8:return"menu";case 16:return"walk";case 32:return"document";case 1:default:return"folder"}}get Url(){return this.url}get Sub(){return this.sub}set Sub(e){this.sub=e}get Color(){return this.isSelected?"tertiary":""}get ColorB(){return this.isSelected?"light":""}SubNodesId(e){e.push(this.ID);for(const t of this.Sub)t.SubNodesId(e)}static get Examples(){const e=[],t=new n(1,"Folder 01"),o=new n(2,"Folder 02"),s=new n(4,"Folder 03"),i=new n(32,"file 01",!0),d=new n(8,"file 02",!0),c=new n(16,"file 03",!0),r=new n(8,"file 04",!0),l=new n(32,"file 05",!0),h=new n(16,"file 06",!0);return t.Sub.push(o),o.Sub.push(i),o.Sub.push(d),o.Sub.push(c),s.Sub.push(r),s.Sub.push(l),s.Sub.push(h),e.push(t),e.push(s),e}}}}]);